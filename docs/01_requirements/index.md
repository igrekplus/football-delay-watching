# 機能要件定義書

## 1. 目的（Purpose）

本システムは、ユーザーが試合結果（スコア・勝敗・得点者など）を一切知らずに録画・配信でサッカー観戦を楽しめるようにすることを目的とする。そのために、試合前の事実情報とニュース・プレビューのみを用い、毎朝 07:00 時点で「前日 07:00〜当日 06:59 に終了した対象試合」について、ネタバレを含まない観戦ガイドを自動生成する。

いわゆる現実世界のマッチプレビューブックとしての位置づけであるとともに、サッカー、クラブの文化や選手の小ネタなどを紹介しながら、サッカー観戦がもっともっと楽しくなることを目指している。

---

## 2. システム全体像

本システムは以下の機能群から構成される（バッチ処理フロー順）。

| No. | 機能名 | 概要 | 詳細要件 |
|-----|--------|------|----------|
| 1 | 試合抽出・選定 (Match) | 対象試合を抽出し、優先順位で最大3試合選定 | [3.1](#31-試合抽出選定-match) |
| 2 | 固定情報取得 (Facts) | スタメン・フォーメーション等の事実情報を取得 | [3.2](#32-固定情報取得-facts) |
| 3 | ニュース処理 (News) | 記事収集・要約・戦術プレビュー・ネタバレ検閲 | [3.3](#33-ニュース処理-news) |
| 4 | YouTube動画取得 (YouTube) | 試合前動画を検索・取得 | [youtube_integration.md](./youtube_integration.md) |
| 5 | レポート生成 (Report) | Markdownレポート出力（選外試合含む） | [3.4](#34-レポート生成-report) |
| 6 | 配信 (Delivery) | HTML変換・メール送信 | [3.5](#35-配信-delivery) |
| 7 | キャッシュウォーミング (CacheWarming) | 上位チームデータの事前取得 | [3.6](#36-キャッシュウォーミング-cachewarming) |

> **Note**: エラーハンドリングは横断的関心事のため、[non_functional.md](./non_functional.md) を参照。

---

## 3. 機能詳細

### 3.1 試合抽出・選定 (Match)

**実装**: `MatchProcessor`, `MatchRanker`, `MatchSelector`

#### 3.1.1 試合抽出

毎日 07:00 に処理を開始し、前日 07:00〜当日 06:59 にキックオフし、かつ終了している試合を抽出する。

- 実行日時：毎日 07:00（JST）
- 対象期間：D-1 07:00〜D 06:59
- 対象リーグ：
  - プレミアリーグ（EPL）
  - UEFA チャンピオンズリーグ（CL）

#### 3.1.2 試合選定

抽出された全試合の中から、レポート対象とする最大 3 試合を選定する。

**ランク定義**

| ランク | 条件 | 説明 |
|--------|------|------|
| 絶対優先 | マンチェスター・シティ | シティの試合が存在する場合、必ず1試合を対象に含める |
| Sランク | ビッグマッチ | CL またはプレミアにおける上位対決（例：1位 vs 2位） |
| Aランク | 日本人選手スタメン | 日本人選手がスタメン出場した試合（途中出場は対象外） |

**枠配分ロジック**
1. シティの試合が存在する場合：
   - 1枠目：シティの試合（絶対優先）
   - 残り2枠：Sランク → Aランクの順に採用
2. シティの試合が存在しない場合：
   - 1〜3枠目：Sランク → Aランクの順に採用
3. 同一ランク内の並び順：
   - CL > プレミア
   - 同一大会内では「順位差が小さい」ものを優先

---

### 3.2 固定情報取得 (Facts)

**実装**: `FactsService`

AI の推論を用いず、外部データソースから取得した事実情報のみを整形し、試合ごとの「固定情報」として提供する。

**必須データ項目**
- 大会名
- キックオフ日時（JST / 現地時間）
- 会場（スタジアム名・都市）
- スタメン（両チーム合計 22 人）
  - 背番号、国籍（国旗絵文字）、選手写真（取得可能な場合）
- ベンチメンバー
- フォーメーション（不明な場合は「不明」、推測禁止）
- フォーメーション図（画像として生成）
- 出場停止・負傷者情報

**任意データ項目**
- 主審
- チームの直近 5 試合の結果（W-L-D）
- 過去の対戦成績（過去5年間に限定、日付・大会・スコアを表示）
- チームの平均 xG / xGA
- チームの平均ポゼッション

---

### 3.3 ニュース処理 (News)

**実装**: `NewsService`

以下のサブ機能を順次実行する。

#### 3.3.1 記事収集・フィルタリング

対象試合に関する「試合前」のニュース・会見・プレビュー記事のみを収集し、試合後記事の混入を防ぐ。

- ニュースソース言語：英語・日本語のみ
- 採用条件：
  - 記事公開日時がキックオフ前
  - 検索クエリに preview 系キーワードを含む
- 禁止アプローチ：
  - 公開日時確認なしの一括取得
  - 文体・時制による判定

#### 3.3.2 ニュース要約

フィルタ済みの記事から、試合前の文脈情報を 600〜1,000 字で要約する。

- 要約対象：監督会見、怪我情報、モチベーション、試合の位置づけ
- 制約：翻訳・要約のみ、推測禁止

#### 3.3.3 戦術プレビュー生成

戦術的な見どころ・キーマッチアップをまとめる。

- 入力：戦術分析記事（英語・日本語）
- 出力：布陣、攻防のポイント、マッチアップ
- 制約：記事に基づく内容のみ、AI発明禁止

#### 3.3.4 ネタバレ検閲

試合結果やスコアに関する情報が紛れ込んでいないかを検査・除去する。

- 検査対象：スコアパターン (`1-0` 等)、結果表現 (`勝った`, `負けた` 等)
- 許容：試合前プレビュー由来の予測表現、過去対戦成績

---

### 3.4 レポート生成 (Report)

**実装**: `ReportGenerator`

各機能で処理された情報を統合し、観戦ガイドレポートを生成する。

**レポート構造**
1. 本日の対象試合サマリー
2. 試合別レポート（最大 3 試合）
   - 基本情報、ニュース要約、戦術プレビュー、エラーステータス
3. 選外試合リスト（選外理由を記録）

---

### 3.5 配信 (Delivery)

**実装**: `HtmlGenerator`, `EmailService`

#### 3.5.1 HTML変換

- Markdownレポートを HTML に変換
- フォーメーション図をインライン埋め込み
- Firebase Hosting にデプロイ

#### 3.5.2 メール送信

- Gmail API でHTMLメールを送信
- 対象：指定のメールアドレス

---

### 3.6 キャッシュウォーミング (CacheWarming)

**実装**: `CacheWarmer`

APIクォータに余裕がある平日に、上位チームの選手データを事前取得する。

- 対象：EPL上位10チーム + CL上位13チーム
- 実行条件：残クォータ > 30、09:00 JST前
- 目的：週末のクォータ消費を抑制
