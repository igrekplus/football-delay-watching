# LLM共通仕様 (LLM Common Specs)

本ドキュメントは、Gemini APIを使用したLLM機能全般に適用される共通の制約と仕様を定義する。

## 1. 概要

### 1.1 目的
- ネタバレ（試合結果）を含まない試合前情報をユーザーに提供する
- LLM出力の品質と安全性を一定水準に保つ
- プロンプト改修時に「何を守るべきか」を明確にする

### 1.2 実装箇所
- **LLMクライアント**: `src/clients/llm_client.py`
- **スポイラーフィルター**: `src/utils/spoiler_filter.py`

## 2. 共通制約（Constraints）

### 2.1 結果言及禁止
以下の情報をLLM出力に含めてはならない：

| カテゴリ | 例 |
|----------|-----|
| スコア | `2-1`, `3-0`, `1-1` |
| 勝敗 | `〇〇が勝利`, `敗北`, `won`, `lost`, `beat` |
| 得点者 | `〇〇がゴール`, `scored`, `netted` |
| 勝ち点 | `勝ち点3獲得`, `points` |

### 2.2 前置き文禁止
LLM応答の冒頭に以下のようなAI応答文を含めてはならない：
- `はい、承知いたしました`
- `以下に〜を記載します`
- `Here is the summary:`

### 2.3 補完・推測禁止
- 入力記事やデータに含まれない情報を補完してはならない
- LLMの事前知識による追記は禁止（※同国対決などの例外を除く）

## 3. 失敗時挙動（Fallback）

### 3.1 APIエラー時
各機能はエラー時に安全なデフォルト値を返すこと。

| 機能 | 挙動 |
|------|------|
| テキスト生成系 | エラーメッセージまたは空文字を返却 |
| 判定系 | 「安全」側の判定（True）を返却 |

### 3.2 モックモード
`USE_MOCK_DATA=True` 時は、Gemini APIを呼び出さず、`MockProvider` から固定のモックデータを返却する。

## 4. 禁止キーワードリスト

**実装**: `src/utils/spoiler_filter.py`

### 4.1 英語キーワード
```python
[
    "won", "lost", "victory", "defeat", "beat", "winner", "loser",
    "goal", "scored", "scoresheet", "netted"
]
```

### 4.2 日本語キーワード
```python
[
    "勝った", "負けた", "勝利", "敗北", "勝ち点3", "points",
    "得点", "ゴール", "先制", "決勝点"
]
```

### 4.3 スコアパターン（正規表現）
```python
# フォーメーション（3-4-3等）を除外し、スコア（2-1等）のみ検出
r'(?<!\d-)(\b\d{1,2}-\d{1,2}\b)(?!-\d)'
```

## 5. チューニングガイドライン

### 5.1 プロンプト変更時の注意
1. **制約の維持**: 上記の禁止事項を必ず含める
2. **本ドキュメントの更新**: プロンプト変更時は本仕様も同期更新する

### 5.2 判定精度の評価
| 指標 | 説明 | 許容方針 |
|------|------|----------|
| False Positive | 安全なテキストを危険と判定 | 警告表示で対応（許容） |
| False Negative | 危険なテキストを見逃し | 最小化を目指す |
