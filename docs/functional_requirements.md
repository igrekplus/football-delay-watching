# 機能要件定義書

> **Last Updated**: 2025-12-31  
> **Version**: 0.8

## 1. 目的（Purpose）

本システムは、ユーザーが試合結果（スコア・勝敗・得点者など）を一切知らずに録画・配信でサッカー観戦を楽しめるようにすることを目的とする。そのために、試合前の事実情報とニュース・プレビューのみを用い、毎朝 07:00 時点で「前日 07:00〜当日 06:59 に終了した対象試合」について、ネタバレを含まない観戦ガイドを自動生成する。

いわゆる現実世界のマッチプレビューブックとしての位置づけであるとともに、サッカー、クラブの文化や選手の小ネタなどを紹介しながら、サッカー観戦がもっともっと楽しくなることを目指している。

---

## 2. システム全体像

本システムは以下の機能群から構成される。

| No. | 機能名 | 概要 |
|-----|--------|------|
| 1 | 試合抽出機能 | 対象期間の試合を抽出 |
| 2 | 試合選定機能 | 優先順位に基づき最大3試合を選定 |
| 3 | 固定情報取得機能（Facts） | スタメン・フォーメーション等の事実情報を取得 |
| 4 | 試合前ニュース収集機能 | プレビュー記事を収集・フィルタリング |
| 5 | 試合前ニュース要約機能 | 記事をAIで要約 |
| 6 | 戦術プレビュー生成機能 | 戦術的見どころを生成 |
| 7 | ネタバレ検閲機能 | 禁止表現をフィルタリング |
| 8 | レポート生成機能 | Markdownレポートを出力 |
| 9 | 選外試合リスト出力機能 | 選外理由を記録 |
| 10 | エラーハンドリング機能 | エラーレベルを管理 |
| 11 | YouTube動画取得機能 | 試合前動画を検索・取得 |

> **Note**: YouTube動画取得機能の詳細仕様は [youtube_integration.md](./architecture/youtube_integration.md) を参照。

---

## 3. 機能詳細

### 3.1 試合抽出機能

**機能概要**  
毎日 07:00 に処理を開始し、前日 07:00〜当日 06:59 にキックオフし、かつ終了している試合を抽出する。

**詳細ロジック**
- 実行日時：毎日 07:00（JST）
- 対象期間：D-1 07:00〜D 06:59
- 対象リーグ：
  - プレミアリーグ（EPL）
  - UEFA チャンピオンズリーグ（CL）

---

### 3.2 試合選定（優先順位）機能

**機能概要**  
抽出された全試合の中から、レポート対象とする最大 3 試合を選定する。

**ランク定義**

| ランク | 条件 | 説明 |
|--------|------|------|
| 絶対優先 | マンチェスター・シティ | シティの試合が存在する場合、必ず1試合を対象に含める |
| Sランク | ビッグマッチ | CL またはプレミアにおける上位対決（例：1位 vs 2位） |
| Aランク | 日本人選手スタメン | 日本人選手がスタメン出場した試合（途中出場は対象外） |

**枠配分ロジック**
1. シティの試合が存在する場合：
   - 1枠目：シティの試合（絶対優先）
   - 残り2枠：Sランク → Aランクの順に採用
2. シティの試合が存在しない場合：
   - 1〜3枠目：Sランク → Aランクの順に採用
3. 同一ランク内の並び順：
   - CL > プレミア
   - 同一大会内では「順位差が小さい（＝上位対決度合いが高い）」ものを優先

---

### 3.3 固定情報取得機能（Facts）

**機能概要**  
AI の推論を用いず、外部データソースから取得した事実情報のみを整形し、試合ごとの「固定情報」として提供する。

**必須データ項目**
- 大会名
- キックオフ日時（JST / 現地時間）
- 会場（スタジアム名・都市）
- スタメン（両チーム合計 22 人）
  - 背番号
  - 国籍（国旗絵文字で表示）
  - 選手写真（取得可能な場合）
- ベンチメンバー
- フォーメーション
  - データソースから提供されない場合は「不明」とする
  - スタメン配置からの推測による補完は禁止
  - フォーメーション図（画像として生成）
- 出場停止・負傷者情報

**任意データ項目（取得できる場合のみ掲載）**
- 主審
- チームの直近 5 試合の結果（W-L-D）
- チームの平均 xG / xGA
- チームの平均ポゼッション

---

### 3.4 試合前ニュース収集・フィルタリング機能

**機能概要**  
対象試合に関する「試合前」のニュース・会見・プレビュー記事のみを収集し、試合後記事の混入を防ぐ。

**ニュースソースの言語**
- 英語
- 日本語
- その他言語は対象外

**採用条件（どちらか一方を満たす記事のみ採用）**
1. 記事の公開日時がキックオフ前であること
   - 公開日時 < 試合キックオフ日時（現地時間またはUTCベース）
2. 検索クエリに preview 系キーワードを必ず含めること
   - 例：`preview`, `match preview`, `before the match`, `プレビュー`

上記を満たさない記事は、試合後記事混入リスクがあるものとして採用しない。

**禁止アプローチ（NG ロジック）**
- 検索結果上位の記事を、公開日時やキーワードに関わらず一括取得すること
- ニュースサイトの「最新ニュース」等のカテゴリから無差別抽出すること
- 記事本文の文体・時制等を機械的に判定して採用すること

---

### 3.5 試合前ニュース要約機能

**機能概要**  
フィルタ済みのニュース・会見・プレビュー記事から、試合前の文脈情報を 600〜1,000 字で要約する。

**要約対象とする内容**
- 前日および前々日の監督会見・選手コメント
- 直近の怪我情報・復帰情報
- モチベーション・クラブ内部の状況に関する報道
- グループステージやリーグ戦における試合の位置づけ（ステークス）
  - 例：現在の順位、勝点差、残り試合数 等
  - ただし「この試合の結果」を前提とする表現は不可

**要約の制約**
- 翻訳・要約のみ行い、新たな推測や独自の解釈は加えない
- 文字数は 600〜1,000 字（固定情報の項目はこの字数に含めない）

---

### 3.6 戦術プレビュー生成機能

**機能概要**  
ニュース要約とは別に、「戦術的な見どころ・キーマッチアップ」をまとめた戦術プレビューを生成する。

**入力となる情報**
- 現地メディアの戦術分析記事（英語・日本語）
- 監督や選手の戦術的言及を含む記事

**出力内容の例**
- 予想される基本布陣と特徴的なポジショニング（事実の範囲）
- どのエリアでの攻防が鍵になると論じられているか
- キープレイヤー同士のマッチアップ（例：左WG vs 右SB）
- プレスのかかり方やビルドアップの形に関する論点

**制約**
- 記事に基づく内容のみをまとめる。AI が独自に戦術を発明してはならない
- スコア予想・勝敗予想が含まれていても「試合前記事であれば」引用・要約してよい
- 記事 URL を併記する

---

### 3.7 ネタバレ検閲機能（禁止表現フィルタ）

**機能概要**  
収集した記事、ニュース要約、戦術プレビューに対して、試合結果やスコアに関する情報が紛れ込んでいないかを検査・除去する機能。レポート生成に渡す直前のレイヤとして動作する。

**適用範囲**
- 試合前ニュース要約テキスト（3.5 の出力）
- 戦術プレビューテキスト（3.6 の出力）
- 収集した記事本文やスニペット

**検査対象となる情報の種類**
- 語彙（単語レベル）
- フレーズ・表現パターン
- 数値パターン（スコアのような形 `1-0`, `2-1`, `3-3` など）

**禁止表現の例**
- スコア関連：`1-0`, `2-1` 等のスコアパターン、`○ゴール`, `先制点`, `決勝点`
- 結果関連：`勝った`, `負けた`, `引き分けた`, `圧勝`, `快勝`, `逆転勝利`, `惨敗`
- 直接的な結果言及：`この試合に勝利したことで…`, `敗戦によって…`

**許容される表現の例**
- 試合前プレビュー由来の未来予測・可能性の議論
  - `もし勝てば首位との勝点差が縮まる`
  - `この試合に敗れるとタイトルレースから後退する可能性がある`
- 過去試合の結果・H2H
  - `過去5試合の対戦成績は3勝1分1敗である`
  - `直近のダービーではホームチームが優位に立ってきた`

---

### 3.8 レポート生成機能

**機能概要**  
各機能で処理された情報を統合し、ユーザーが毎朝読むことを前提とした「観戦ガイドレポート」を、統一されたテンプレートで出力する。

**レポート全体構造**
1. 本日の対象試合サマリー
2. 試合別レポート（最大 3 試合）
3. 選外試合リスト

**試合別レポート構造**
```markdown
## 試合1：マンチェスター・シティ vs ○○（プレミア／絶対優先）

### ■ 基本情報（固定情報）
- 大会：
- 日時：YYYY/MM/DD HH:MM JST / HH:MM 現地
- 会場：
- スタメン：
- ベンチ：
- フォーメーション：
- 出場停止・負傷者情報：
- H2H（過去5試合の結果）：
- 主審：

### ■ ニュース要約（600〜1,000字）
（ネタバレ検閲通過済みテキスト）

### ■ 戦術プレビュー
（ネタバレ検閲通過済みテキスト）

### ■ エラーステータス
E1 / E2 / E3 / 正常
```

---

### 3.9 選外試合リスト出力機能

選定されなかった試合の一覧と選外理由を記録する。

**出力形式**
```markdown
## 選外試合リスト

- ○○ vs ○○（プレミア）… 日本人選手ベンチ外のため選外
- ○○ vs ○○（CL）… Sランクだが枠超過のため選外
- ○○ vs ○○（プレミア）… 情報取得エラー（E1）
```

---

### 3.10 エラーハンドリング機能

| レベル | 説明 | 例 |
|--------|------|-----|
| E1 | クリティカル：試合情報自体が取得できない | API障害、URL失効 |
| E2 | 部分欠損：固定情報の一部が欠損 | フォーメーション取得不可 |
| E3 | 軽微：ニュース・プレビューが極端に少ない | 記事が少ない、検閲で削除が多い |

エラーレベルは試合別レポート内に明示する。
