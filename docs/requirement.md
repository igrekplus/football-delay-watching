ネタバレ厳禁・サッカー観戦ガイド自動生成システム
要件定義書 v0.8

## 目的（Purpose）
本システムは、ユーザーが試合結果（スコア・勝敗・得点者など）を一切知らずに録画・配信でサッカー観戦を楽しめるようにすることを目的とする。そのために、試合前の事実情報とニュース・プレビューのみを用い、毎朝 07:00 時点で「前日 07:00〜当日 06:59 に終了した対象試合」について、ネタバレを含まない観戦ガイドを自動生成する。いわゆる現実世界のマッチプレビューブックとしての位置づけであるとともに、サッカー、クラブの文化や選手の小ネタなどを紹介しながら、サッカー観戦がもっともっと楽しくなることを目指している。

## システム全体像
本システムは以下の機能群から構成される。
1. 試合抽出機能
2. 試合選定（優先順位）機能
3. 固定情報取得機能（Facts）
4. 試合前ニュース収集・フィルタリング機能
5. 試合前ニュース要約機能
6. 戦術プレビュー生成機能
7. ネタバレ検閲機能（3.4/3.5/3.6 のテキストに対するネガティブフィルタ）
8. レポート生成機能
9. 選外試合リスト出力機能
10. エラーハンドリング機能
11. **YouTube動画取得機能** → [youtube_requirement.md](./youtube_requirement.md)

## 機能一覧・機能詳細

### 試合抽出機能
**機能概要**  
毎日 07:00 に処理を開始し、前日 07:00〜当日 06:59 にキックオフし、かつ終了している試合を抽出する。

**詳細ロジック**  
- 実行日時：毎日 07:00（JST）  
- 対象期間：D-1 07:00〜D 06:59  
- 対象リーグ：  
  - プレミアリーグ（EPL）  
  - UEFA チャンピオンズリーグ（CL）

### 試合選定（優先順位）機能
**機能概要**  
抽出された全試合の中から、レポート対象とする最大 3 試合を選定する。

**ランク定義**  
- 【絶対優先】マンチェスター・シティ  
  - 実施日にシティの試合が存在する場合、必ず 1 試合を対象に含める。  
- 【Sランク】ビッグマッチ  
  - CL またはプレミアにおける上位対決（例：1位 vs 2位 等）。  
- 【Aランク】日本人選手がスタメン出場した試合  
  - 途中出場のみの試合は対象外。

**枠配分ロジック**  
1. シティの試合が存在する場合：  
   - 1枠目：シティの試合（絶対優先）  
   - 残り 2 枠：Sランク → Aランクの順に採用  
2. シティの試合が存在しない場合：  
   - 1枠目〜3枠目：Sランク → Aランクの順に採用  
3. 同一ランク内の並び順：  
   - CL > プレミア  
   - 同一大会内では「順位差が小さい（＝上位対決度合いが高い）」ものを優先

### 固定情報取得機能（Facts）
**機能概要**  
AI の推論を用いず、外部データソースから取得した事実情報のみを整形し、試合ごとの「固定情報」として提供する。

**必須データ項目**  
- 大会名  
- キックオフ日時（JST / 現地時間）  
- 会場（スタジアム名・都市）  
- スタメン（両チーム合計 22 人）  
  - 背番号  
  - 国籍（国旗絵文字で表示）  
  - 選手写真（取得可能な場合）  
- ベンチメンバー  
- フォーメーション  
  - データソースから提供されない場合は「不明」とする。  
  - スタメン配置からの推測による補完は禁止。  
  - フォーメーション図（画像として生成）  
- 出場停止・負傷者情報

**任意データ項目（取得できる場合のみ掲載）**  
- 主審  
- チームの直近 5 試合の結果（W-L-D）  
- チームの平均 xG / xGA  
- チームの平均ポゼッション

### 試合前ニュース収集・フィルタリング機能
**機能概要**  
対象試合に関する「試合前」のニュース・会見・プレビュー記事のみを収集し、試合後記事の混入を防ぐ。

**ニュースソースの言語**  
- 英語  
- 日本語  
その他言語は対象外とする。

**採用条件（どちらか一方を満たす記事のみ採用）**  
1. 記事の公開日時がキックオフ前であること  
   - 公開日時 < 試合キックオフ日時（現地時間またはUTCベース）  
2. 検索クエリに preview 系キーワードを必ず含めること  
   - 例："preview", "match preview", "before the match", "プレビュー"  
上記 1,2 のいずれかを満たさない記事は、試合後記事混入リスクがあるものとして採用しない。

**禁止アプローチ（NG ロジック）**  
- 検索結果上位の記事を、公開日時やキーワードに関わらず一括取得すること  
- ニュースサイトの「最新ニュース」「トップニュース」等のカテゴリから無差別抽出すること  
- 記事本文の文体・時制等を機械的に判定して「プレビューっぽいから採用」とすること  
これらはすべて、試合後記事を拾う可能性があるため禁止する。

### 試合前ニュース要約機能
**機能概要**  
3.4 でフィルタ済みのニュース・会見・プレビュー記事から、試合前の文脈情報を 600〜1,000 字で要約する。

**要約対象とする内容**  
- 前日および前々日の監督会見・選手コメント  
- 直近の怪我情報・復帰情報  
- モチベーション・クラブ内部の状況に関する報道  
- グループステージやリーグ戦における試合の位置づけ（ステークス）  
  - 例：現在の順位、勝点差、残り試合数 等  
  - ただし「この試合の結果」を前提とする表現は不可。

**要約の制約**  
- 翻訳・要約のみ行い、新たな推測や独自の解釈は加えない。  
- 文字数は 600〜1,000 字（固定情報の項目はこの字数に含めない）。

### 戦術プレビュー生成機能
**機能概要**  
ニュース要約とは別に、「戦術的な見どころ・キーマッチアップ」をまとめた戦術プレビューを生成する。

**入力となる情報**  
- 現地メディアの戦術分析記事（英語・日本語）  
- 監督や選手の戦術的言及を含む記事

**出力内容の例**  
- 予想される基本布陣と特徴的なポジショニング（事実の範囲）  
- どのエリアでの攻防が鍵になると論じられているか  
- キープレイヤー同士のマッチアップ（例：左WG vs 右SB）  
- プレスのかかり方やビルドアップの形に関する論点

**制約**  
- 記事に基づく内容のみをまとめる。AI が独自に戦術を発明してはならない。  
- スコア予想・勝敗予想が含まれていても「試合前記事であれば」引用・要約してよい。  
- 記事 URL を併記する（ただしクリック先で結果が見えてしまうリスクはユーザー側の許容範囲とする）。

### ネタバレ検閲機能（禁止表現フィルタ）
**機能概要**  
3.4 で収集した記事、ならびに 3.5（ニュース要約）、3.6（戦術プレビュー）で生成されたテキストに対して、試合結果やスコアに関する情報が紛れ込んでいないかを検査・除去する機能である。この機能は、3.4〜3.6 で処理されたテキストの「最終出口」に挿入され、レポート生成（3.8）に渡す直前のレイヤとして動作する。

**適用範囲**  
- 試合前ニュース要約テキスト（3.5 の出力）  
- 戦術プレビューテキスト（3.6 の出力）  
- 必要に応じて、3.4 で取得した記事本文やスニペットにも事前チェックを行い、「明らかに試合後記事である」と判定できる場合はその記事自体を破棄する。

**検査対象となる情報の種類**  
- 語彙（単語レベル）  
- フレーズ・表現パターン  
- 数値パターン（スコアのような形 [“1-0”,“2-1”,“3-3”] など）

**禁止表現の例**  
- スコア関連：  
  - 「1-0」「2-1」「3-3」等のスコアパターン  
  - 「○ゴール」「先制点」「決勝点」など、得点に直結する表現  
- 結果関連：  
  - 勝った／負けた／引き分けた／圧勝／快勝／逆転勝利／惨敗 など  
  - 「勝点を伸ばした」「連勝を伸ばした」「連敗が止まった」等  
- 直接的な結果言及：  
  - 「この試合に勝利したことで…」「敗戦によって…」

**許容される表現の例**  
- 試合前プレビュー由来の未来予測・可能性の議論  
  - 「もし勝てば首位との勝点差が縮まる」  
  - 「この試合に敗れるとタイトルレースから後退する可能性がある」  
- 過去試合の結果・H2H  
  - 「過去5試合の対戦成績は3勝1分1敗である」  
  - 「直近のダービーではホームチームが優位に立ってきた」

**処理の流れ**  
1. 3.4 収集段階  
   - 記事の公開日時や検索クエリで試合前かどうかを一次判定。  
   - 明らかに「○○が勝利」「○○が2-1で制す」等の表現をタイトルに含む記事は収集対象から除外する。  
2. 3.5 / 3.6 要約段階  
   - 元記事の情報を要約する際、禁止表現をそのままコピーしないことが望ましいが、ここでは「人間によるレビューなしで実行される前提」のため、完全には抑制できない。  
3. 3.7 検閲段階（本機能）  
   - 要約済みテキストに対して、禁止表現リストおよびスコアパターンに基づくチェックを行う。  
   - 発見された場合：  
     - 文単位で削除するか、問題箇所をマスク（削除）する。  
     - 内容が大きく損なわれる場合は、「一部の文脈情報はネタバレ回避のため省略」といった代替文で置き換える。

**成果物への影響**  
- 禁止表現が削除された結果、ニュース要約が短くなったり、文と文のつながりが弱くなる場合があるが、それは許容とする。  
- 重要な部分が削除された場合は、3.8 のエラーレベル（E3：軽微）などで補足してもよい。

### レポート生成機能
**機能概要**  
3.2〜3.7 の各機能で処理された情報を統合し、ユーザーが毎朝読むことを前提とした「観戦ガイドレポート」を、統一されたテンプレートで出力する。

**レポート全体構造**  
1. 本日の対象試合サマリー  
2. 試合別レポート（最大 3 試合）  
3. 選外試合リスト

**本日の対象試合サマリー**  
- 日次で選定された試合を一覧にする。  
- 各行には以下を含める：  
  - 対戦カード（ホーム vs アウェイ）  
  - 大会  
  - キックオフ日時（JST / 現地）  
  - ランク（絶対優先 / S / A）  

例（Markdown 想定）：  

# 本日の対象試合（3件）

1. マンチェスター・シティ vs ○○（プレミア／絶対優先）  
2. ○○ vs ○○（CL／Sランク）  
3. ○○ vs ○○（プレミア／Aランク）

**試合別レポート構造**  
各試合について、以下の構造で出力する。

## 試合1：マンチェスター・シティ vs ○○（プレミア／絶対優先）

### ■ 基本情報（固定情報）
- 大会：  
- 日時：YYYY/MM/DD HH:MM JST / HH:MM 現地  
- 会場：  
- スタメン：  
- ベンチ：  
- フォーメーション：  
- 出場停止・負傷者情報：  
- H2H（過去5試合の結果）：（例：3勝1分1敗）  
- 主審：（取得できる場合のみ）

### ■ ニュース要約（600〜1,000字）
- 3.4 / 3.5 を経て生成された試合前の文脈情報  
- ネタバレ検閲（3.7）通過済みのテキストのみ掲載

### ■ 戦術プレビュー
- 3.6 の結果（戦術分析の要約）  
- URL（プレビュー記事の参照元）  
- ネタバレ検閲（3.7）通過済みのテキストのみ掲載

### ■ エラーステータス
- E1 / E2 / E3 / 正常  
- 必要に応じて補足コメント（例：フォーメーション情報が取得できなかったため簡略化）

**選外試合リスト**  
- 試合カード  
- 大会  
- 選外理由

例：  

## 選外試合リスト

- ○○ vs ○○（プレミア）… 日本人選手ベンチ外のため選外  
- ○○ vs ○○（CL）… Sランクだが枠超過のため選外  
- ○○ vs ○○（プレミア）… 情報取得エラー（E1）

### 選外試合リスト出力機能
（内容は上記「選外試合リスト」に準拠。詳細は省略）

### エラーハンドリング機能
- E1：試合情報自体が取得できない  
- E2：固定情報の一部が欠損（フォーメーション等）  
- E3：ニュース・プレビューが極端に少ない、ネタバレ検閲で多くの文が削除された 等  
エラーレベルは試合別レポート内に明示する。

## データ項目定義・非機能要件・制約
承知しました。要件定義書 v0.7 の「4. データ項目定義・非機能要件・制約」は前回の回答では「省略せずに必要なら整理する」と書いたのみで、正式に記述していませんでした。以下に、要件定義書として成立させるための 第4章 を正式に整形して再掲します。あなたが求める「LLM が読んでも誤解しない」「機能とデータの境界が明確」な構造に合わせています。

本章では、本システムが扱うデータの型と項目を定義し、また本システムが満たすべき非機能要件および制約条件をまとめる。

### データ項目定義

#### 試合メタ情報（Match Metadata）
項目名	必須	説明	備考  
大会名	Yes	EPL / CL	外部データソースより取得  
キックオフ日時（JST）	Yes	日本時間でのキックオフ	“YYYY/MM/DD HH:MM JST”  
キックオフ日時（現地）	Yes	スタジアム所在地の現地時間	タイムゾーン変換必須  
会場	Yes	スタジアム名・都市	外部データソースより取得

#### チーム情報（Team Data）
項目名	必須	説明	備考  
スタメン（11名）	Yes	AI推論禁止、事実データのみ	必須  
ベンチメンバー	Yes	リザーブリスト	必須  
フォーメーション	Yes	データソースに存在しない場合は「不明」	推論禁止  
出場停止・負傷者情報	Yes	試合前の公式・準公式情報	ニュースソース含む  
主審	Optional	主審名	取得できる場合のみ  
過去5試合フォーム（W-L-D）	Optional	チーム直近5試合の結果	スコア数値は取り扱わない  
xG / xGA	Optional	試合前の平均値	入手性に依存  
平均ポゼッション	Optional	シーズン平均値	入手性に依存

#### 試合前記事（Pre-match Articles）
項目名	必須	説明	採用条件  
記事タイトル	Yes	フィルタリング時に使用	NG判定に重要  
記事本文	Yes	要約対象	試合前記事のみ採用  
公開日時	Yes	キックオフ前判定に使用	“公開日時 < キックオフ”  
URL	Yes	透明性のため掲載	結果記事に飛ぶリスクは許容  
言語	Yes	英語・日本語に限定	他言語は禁止

#### 要約結果（Summaries）
項目名	必須	説明  
ニュース要約本文（600〜1,000字）	Yes	試合前の文脈情報  
戦術プレビュー本文	Yes	戦術分析のみ  
禁止表現削除後テキスト	Yes	ネタバレ検閲後の最終テキスト

#### エラーステータス（Error Status）
レベル	説明	例  
E1	クリティカル：試合情報全体が取得不可能	API障害、URL失効など  
E2	部分欠損：固定情報の一部欠損	フォーメーション取得不可 等  
E3	軽微：ニュースやプレビュー不足	記事が少ない、検閲で削除が多すぎた 等

#### 選外試合（Excluded Matches）
項目名	必須	説明  
試合カード	Yes	ホーム vs アウェイ  
大会名	Yes	EPL / CL  
選外理由	Yes	ベンチ外、枠不足、情報不足 等

### 非機能要件（Non-functional Requirements）

#### 正確性（Accuracy）
- AI の推論は禁止し、すべて外部ソースの事実データのみを採用すること。  
- フォーメーションなど不明な項目について、推定・推測ロジックを使用してはならない。

#### ネタバレ防止（No-spoiler Integrity）
- ネタバレ検閲機能を必ず経由し、禁止表現・スコアパターン等が残存しないようにする。  
- 記事収集段階（試合前ニュース収集）および要約後（試合前ニュース要約／戦術プレビュー）の双方で二重で監視する仕組みとする。

#### 透明性（Transparency）
- 使用した記事の URL を必ず掲載する。  
- URL リンク先が後日更新され結果を含む可能性は、ユーザーが許容する前提とする。

#### 読みやすさ（Readability）
- レポート全体は一定のフォーマットに準拠し、毎日同じ構造で出力する。  
- ニュース要約は 600〜1,000 字に収め、固定情報はこの字数に含めない。

#### 安定性（Robustness）
- 取得不能なデータがある場合でも処理が止まらず、「不明」「E2」等の状態を明示してレポート生成まで到達する。  
- クリティカルエラー（E1）の試合についても、他試合は処理継続する。  
- GCSキャッシュにより、同一選手の情報は2回目以降の取得が高速化され、API障害時も既存キャッシュからの復旧が可能。

#### 拡張性（Extensibility）
- 大会追加（例：ラ・リーガ、EL、国内リーグなど）を将来的に容易にする構成とする。  
- 優先順位ロジックはランク定義の更新によって変更可能な設計とする。

### 制約条件（Constraints）

#### 言語制約
- 記事は 英語・日本語のみ採用。  
- 他言語の記事はフィルタ段階で必ず除外する。

#### データ取得制約
- データソースの停止や API 制限により情報が得られない場合がある。  
- 取得不能項目は埋めず、「不明」として扱う（エラーハンドリングに基づく）。

#### APIクォータ制約
- API-Football の無料枠は 100リクエスト/日 であり、週末の複数試合処理時にクォータ不足のリスクがある。  
- 選手データ（国籍・背番号・写真）はGCSにキャッシュし、同一選手への再リクエストを回避する。  
- 平日で試合がない場合、キャッシュウォーミング機能により上位チームの選手データを事前取得しておくことで、週末のクォータ消費を抑制する。

#### 推論禁止
- AI が独自に推論・補完して事実を生成することは禁止。  
- フォーメーション、怪我情報、出場停止情報を「推測」してはならない。  
- 推論はニュース要約本文の言語変換・要約のみ。

#### ネタバレ禁止（強制）
- スコア・勝敗・得点者などの “結果” を直接または間接に示唆する表現を含んではならない。  
- 試合後に更新された記事を誤って採用してはならない。
