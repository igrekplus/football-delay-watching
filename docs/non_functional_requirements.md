# 非機能要件・データ定義書

> **Last Updated**: 2025-12-31  
> **Version**: 0.8

このドキュメントでは、本システムが扱うデータの型と項目を定義し、また本システムが満たすべき非機能要件および制約条件をまとめる。

---

## 1. データ項目定義

### 1.1 試合メタ情報（Match Metadata）

| 項目名 | 必須 | 説明 | 備考 |
|--------|------|------|------|
| 大会名 | Yes | EPL / CL | 外部データソースより取得 |
| キックオフ日時（JST） | Yes | 日本時間でのキックオフ | `YYYY/MM/DD HH:MM JST` |
| キックオフ日時（現地） | Yes | スタジアム所在地の現地時間 | タイムゾーン変換必須 |
| 会場 | Yes | スタジアム名・都市 | 外部データソースより取得 |

### 1.2 チーム情報（Team Data）

| 項目名 | 必須 | 説明 | 備考 |
|--------|------|------|------|
| スタメン（11名） | Yes | AI推論禁止、事実データのみ | 必須 |
| ベンチメンバー | Yes | リザーブリスト | 必須 |
| フォーメーション | Yes | データソースに存在しない場合は「不明」 | 推論禁止 |
| 出場停止・負傷者情報 | Yes | 試合前の公式・準公式情報 | ニュースソース含む |
| 主審 | Optional | 主審名 | 取得できる場合のみ |
| 過去5試合フォーム（W-L-D） | Optional | チーム直近5試合の結果 | スコア数値は取り扱わない |
| xG / xGA | Optional | 試合前の平均値 | 入手性に依存 |
| 平均ポゼッション | Optional | シーズン平均値 | 入手性に依存 |

### 1.3 試合前記事（Pre-match Articles）

| 項目名 | 必須 | 説明 | 採用条件 |
|--------|------|------|----------|
| 記事タイトル | Yes | フィルタリング時に使用 | NG判定に重要 |
| 記事本文 | Yes | 要約対象 | 試合前記事のみ採用 |
| 公開日時 | Yes | キックオフ前判定に使用 | `公開日時 < キックオフ` |
| URL | Yes | 透明性のため掲載 | 結果記事に飛ぶリスクは許容 |
| 言語 | Yes | 英語・日本語に限定 | 他言語は禁止 |

### 1.4 要約結果（Summaries）

| 項目名 | 必須 | 説明 |
|--------|------|------|
| ニュース要約本文（600〜1,000字） | Yes | 試合前の文脈情報 |
| 戦術プレビュー本文 | Yes | 戦術分析のみ |
| 禁止表現削除後テキスト | Yes | ネタバレ検閲後の最終テキスト |

### 1.5 エラーステータス（Error Status）

| レベル | 説明 | 例 |
|--------|------|-----|
| E1 | クリティカル：試合情報全体が取得不可能 | API障害、URL失効など |
| E2 | 部分欠損：固定情報の一部欠損 | フォーメーション取得不可 等 |
| E3 | 軽微：ニュースやプレビュー不足 | 記事が少ない、検閲で削除が多すぎた 等 |

### 1.6 選外試合（Excluded Matches）

| 項目名 | 必須 | 説明 |
|--------|------|------|
| 試合カード | Yes | ホーム vs アウェイ |
| 大会名 | Yes | EPL / CL |
| 選外理由 | Yes | ベンチ外、枠不足、情報不足 等 |

---

## 2. 非機能要件（Non-functional Requirements）

### 2.1 正確性（Accuracy）

- AI の推論は禁止し、すべて外部ソースの事実データのみを採用すること
- フォーメーションなど不明な項目について、推定・推測ロジックを使用してはならない

### 2.2 ネタバレ防止（No-spoiler Integrity）

- ネタバレ検閲機能を必ず経由し、禁止表現・スコアパターン等が残存しないようにする
- 記事収集段階（試合前ニュース収集）および要約後（試合前ニュース要約／戦術プレビュー）の双方で二重で監視する仕組みとする

### 2.3 透明性（Transparency）

- 使用した記事の URL を必ず掲載する
- URL リンク先が後日更新され結果を含む可能性は、ユーザーが許容する前提とする

### 2.4 読みやすさ（Readability）

- レポート全体は一定のフォーマットに準拠し、毎日同じ構造で出力する
- ニュース要約は 600〜1,000 字に収め、固定情報はこの字数に含めない

### 2.5 安定性（Robustness）

- 取得不能なデータがある場合でも処理が止まらず、「不明」「E2」等の状態を明示してレポート生成まで到達する
- クリティカルエラー（E1）の試合についても、他試合は処理継続する
- GCSキャッシュにより、同一選手の情報は2回目以降の取得が高速化され、API障害時も既存キャッシュからの復旧が可能

### 2.6 拡張性（Extensibility）

- 大会追加（例：ラ・リーガ、EL、国内リーグなど）を将来的に容易にする構成とする
- 優先順位ロジックはランク定義の更新によって変更可能な設計とする

---

## 3. 制約条件（Constraints）

### 3.1 言語制約

- 記事は **英語・日本語のみ** 採用
- 他言語の記事はフィルタ段階で必ず除外する

### 3.2 データ取得制約

- データソースの停止や API 制限により情報が得られない場合がある
- 取得不能項目は埋めず、「不明」として扱う（エラーハンドリングに基づく）

### 3.3 APIクォータ制約

- API-Football の Pro プランは 7,500リクエスト/日
- 週末の複数試合処理時にクォータ不足のリスクがある
- 選手データ（国籍・背番号・写真）はGCSにキャッシュし、同一選手への再リクエストを回避する
- 平日で試合がない場合、キャッシュウォーミング機能により上位チームの選手データを事前取得しておくことで、週末のクォータ消費を抑制する

> **Note**: APIクォータの詳細は [api_quota.md](./api_quota.md) を参照

### 3.4 推論禁止

- AI が独自に推論・補完して事実を生成することは禁止
- フォーメーション、怪我情報、出場停止情報を「推測」してはならない
- 推論はニュース要約本文の言語変換・要約のみ

### 3.5 ネタバレ禁止（強制）

- スコア・勝敗・得点者などの "結果" を直接または間接に示唆する表現を含んではならない
- 試合後に更新された記事を誤って採用してはならない
