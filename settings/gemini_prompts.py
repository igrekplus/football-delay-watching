"""
Geminiãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š

LLMClientç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é›†ç´„ã€‚
ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¤‰æ›´ã™ã‚Œã°è‰¯ã„è¨­è¨ˆã€‚

Issue #120: LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¤–éƒ¨è¨­å®šåŒ–ï¼ˆç–çµåˆåŒ–ï¼‰
"""

from typing import Dict, Any, Optional, Tuple


# =============================================================================
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
#
# å„ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨è¨­å®šã‚’å®šç¾©ã€‚
# LLMClientã¯ã“ã®ã‚¹ãƒšãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
# =============================================================================

GEMINI_PROMPTS: Dict[str, Dict[str, Any]] = {
    "news_summary": {
        "label": "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µãƒãƒªãƒ¼",
        "template": """Task: {home_team} vs {away_team} ã®è©¦åˆã«é–¢ã™ã‚‹æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’æ¤œç´¢ã—ã€æ—¥æœ¬èªã§è©¦åˆå‰ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## æ¤œç´¢æŒ‡ç¤º
- "{home_team} vs {away_team} preview"
- "{home_team} {away_team} news"
- ç›´è¿‘48æ™‚é–“ä»¥å†…ã®è¨˜äº‹ã‚’å„ªå…ˆ

## è¦ç´„ã®è¦ä»¶
- ä¸¡ãƒãƒ¼ãƒ ã®æœ€æ–°çŠ¶æ³ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨˜è¿°
- è©¦åˆçµæœï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã¯çµ¶å¯¾ã«å«ã‚ãªã„
- è² å‚·ã«ã‚ˆã‚‹æ¬ å ´æƒ…å ±ã¯å«ã‚ãªã„ï¼ˆæ—¢ã«ã‚¹ã‚¿ãƒ¡ãƒ³æƒ…å ±ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
- ãŸã ã—ã€æ€ªæˆ‘ã‹ã‚‰ã®ã€Œå¾©å¸°ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ç©æ¥µçš„ã«å«ã‚ã‚‹
- 600-1000å­—ç¨‹åº¦

## å‡ºåŠ›å½¢å¼
- å‰ç½®ãæ–‡ä¸è¦ã€æœ¬æ–‡ã®ã¿""",
        "char_limit": (600, 1000),
        "use_grounding": True,
    },

    "tactical_preview": {
        "label": "æˆ¦è¡“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
        "template": """Task: {home_team} vs {away_team} ã®æˆ¦è¡“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆç¢ºå®šæƒ…å ±ï¼‰
### {home_team}ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: {home_formation}
- ã‚¹ã‚¿ãƒ¡ãƒ³: {home_lineup}

### {away_team}ï¼ˆã‚¢ã‚¦ã‚§ã‚¤ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: {away_formation}
- ã‚¹ã‚¿ãƒ¡ãƒ³: {away_lineup}

## æ¤œç´¢æŒ‡ç¤º
### æˆ¦è¡“å‚¾å‘ï¼ˆéå»6ãƒ¶æœˆã®è¨˜äº‹ã‚’æ¤œç´¢ï¼‰
- "{home_team} tactics analysis 2025 2026"
- "{away_team} formation style"
- è©¦åˆãŒé–‹å‚¬ã•ã‚Œã‚‹å›½ï¼ˆ{competition}ï¼‰ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å„ªå…ˆ

## å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšä»¥ä¸‹ã®3ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†ã‘ã¦è¨˜è¿°ï¼‰

### âš½ ã‚­ãƒ¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
- å„ãƒãƒ¼ãƒ 1-2åã®æ³¨ç›®é¸æ‰‹ã‚’æŒ™ã’ã€ãã®ç†ç”±ã‚’è¨˜è¿°

### ğŸ¯ æˆ¦è¡“ã‚¹ã‚¿ã‚¤ãƒ«
- å„ãƒãƒ¼ãƒ ã®å¾—æ„ã¨ã™ã‚‹æˆ¦è¡“ï¼ˆå …å®ˆã€ãƒã‚¼ãƒƒã‚·ãƒ§ãƒ³ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç­‰ï¼‰ã‚’éå»6ãƒ¶æœˆã®å‚¾å‘ã‹ã‚‰è¨˜è¿°
- å…·ä½“çš„ãªç›£ç£ã®æˆ¦è¡“å¤‰æ›´ã‚„ç‰¹å¾´çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Œã°è¨€åŠ

### ğŸ”¥ ã‚­ãƒ¼ãƒãƒƒãƒã‚¢ãƒƒãƒ—
- æ³¨ç›®ã®å¯¾æ±ºï¼ˆä¾‹ï¼šå·¦ã‚µã‚¤ãƒ‰ãƒãƒƒã‚¯ vs å³ã‚¦ã‚¤ãƒ³ã‚°ï¼‰ã‚’å…·ä½“çš„ãªé¸æ‰‹åã¨ã¨ã‚‚ã«è¨˜è¿°
- ãªãœãã®å¯¾æ±ºãŒé‡è¦ãªã®ã‹ã€ã©ã¡ã‚‰ãŒæœ‰åˆ©ã‹ã€ä¸¡é¸æ‰‹ã®ç‰¹å¾´ã‚’æ¯”è¼ƒã—ã¦è©³ã—ãè¨˜è¿°
- 1ã¤ä»¥ä¸Šã®å¯¾æ±ºã‚’æŒ™ã’ã€ãã‚Œãã‚Œã«å…·ä½“çš„ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‹

## é‡è¦ãªåˆ¶ç´„
- è©¦åˆçµæœï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã¯çµ¶å¯¾ã«å«ã‚ãªã„
- å‰ç½®ãæ–‡ä¸è¦ã€æœ¬æ–‡ã®ã¿
- ã‚¹ã‚¿ãƒ¡ãƒ³ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„é¸æ‰‹ã‚’æŒ™ã’ãªã„

## çµ¶å¯¾ç¦æ­¢äº‹é …
- ä»¥ä¸‹ã®ã‚ˆã†ãª**ãƒ¡ã‚¿çš„ãªå‰ç½®ããƒ»çŠ¶æ³èª¬æ˜ã¯ä¸€åˆ‡æ›¸ã‹ãªã„**ã€‚ã„ããªã‚Šæœ¬é¡Œã®å†…å®¹ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã€‚
  - NGä¾‹: ã€Œxx vs xx ã®æˆ¦è¡“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€
  - NGä¾‹: ã€Œãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¦æƒ…å ±ã‚’åé›†ã—ã¾ã—ãŸã€
  - NGä¾‹: ã€Œä»¥ä¸‹ã®æƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€
- ã€Œæ‰¿çŸ¥ã—ã¾ã—ãŸã€ã€Œç”Ÿæˆã—ã¾ã™ã€ãªã©ã®AIã®å¿œç­”ã¯å«ã‚ãªã„
- ã“ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ä»¥å¤–ã®è©¦åˆã«é–¢ã™ã‚‹æƒ…å ±""",
        "use_grounding": True,
    },

    "check_spoiler": {
        "label": "ãƒã‚¿ãƒãƒ¬åˆ¤å®š",
        "template": """ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã€Œ{home_team} vs {away_team}ã€ã®è©¦åˆçµæœã‚’è¨€åŠã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

ãƒ†ã‚­ã‚¹ãƒˆ:
{text}

åˆ¤å®šåŸºæº–:
- ã‚¹ã‚³ã‚¢ï¼ˆä¾‹: 2-1, 3-0ï¼‰ã®è¨˜è¼‰
- å‹æ•—ã®è¨˜è¼‰ï¼ˆä¾‹: ã€‡ã€‡ãŒå‹åˆ©ã€æ•—åŒ—ã€won, lostï¼‰
- ã‚´ãƒ¼ãƒ«ã‚’æ±ºã‚ãŸé¸æ‰‹åï¼ˆå¾—ç‚¹è€…ï¼‰

å›ç­”ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§ï¼ˆèª¬æ˜ä¸è¦ï¼‰:
{{"is_safe": true, "reason": "ãªã—"}} ã¾ãŸã¯ {{"is_safe": false, "reason": "ç†ç”±"}}""",
        "text_limit": 1500,
        "use_grounding": False,
    },

    "interview": {
        "label": "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼è¦ç´„",
        "template": """ã‚ãªãŸã¯ã‚µãƒƒã‚«ãƒ¼å°‚é–€ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚

Task: {team_name}ã®ç›£ç£ãŒã€{match_info} ã®è©¦åˆã«å‘ã‘ã¦èªã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚„è¨˜è€…ä¼šè¦‹ã®å†…å®¹ã‚’æ¤œç´¢ã—ã€æ—¥æœ¬èªã®è¨˜äº‹ã¨ã—ã¦æ›¸ãèµ·ã“ã—ã¦ãã ã•ã„ã€‚

## æ¤œç´¢æŒ‡ç¤º
- "{team_name} manager press conference" + "{search_query}"
- ç›´è¿‘24-48æ™‚é–“ä»¥å†…ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨
- {search_context}

## çµ¶å¯¾ç¦æ­¢äº‹é …
- ä»¥ä¸‹ã®ã‚ˆã†ãª**ãƒ¡ã‚¿çš„ãªå‰ç½®ããƒ»çŠ¶æ³èª¬æ˜ã¯ä¸€åˆ‡æ›¸ã‹ãªã„**ã€‚ã„ããªã‚Šæœ¬é¡Œã®å†…å®¹ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã€‚
  - NGä¾‹: ã€Œxxç›£ç£ã¯è¨˜è€…ä¼šè¦‹ã§è¿°ã¹ã¾ã—ãŸã€
  - NGä¾‹: ã€Œä»¥ä¸‹ã®æƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€
  - NGä¾‹: ã€Œã‚µãƒƒã‚«ãƒ¼å°‚é–€ã‚¸ãƒ£ãƒ¼ãƒŠãƒªã‚¹ãƒˆã¨ã—ã¦ã€ã€œã®è¨˜äº‹ã«ã¾ã¨ã‚ã¾ã™ã€
  - NGä¾‹: ã€Œã€œã«ã¤ã„ã¦ãŠä¼ãˆã—ã¾ã™ã€
- ã€Œæ‰¿çŸ¥ã—ã¾ã—ãŸã€ã€Œè¦ç´„ã—ã¾ã™ã€ãªã©ã®AIã®å¿œç­”ã¯å«ã‚ãªã„
- ã“ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ï¼ˆ{match_info}ï¼‰ä»¥å¤–ã®è©¦åˆã«é–¢ã™ã‚‹æƒ…å ±
- ãƒ¬ã‚¢ãƒ«ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰ã€ãƒãƒ«ã‚»ãƒ­ãƒŠãªã©ä»–ã®å¯¾æˆ¦ç›¸æ‰‹ã¸ã®è¨€åŠ
- 1é€±é–“ä»¥ä¸Šå‰ã®å¤ã„æƒ…å ±
- è©¦åˆçµæœï¼ˆã‚¹ã‚³ã‚¢ï¼‰

## å‡ºåŠ›ã®è¦ä»¶
- ç›£ç£ã®å…·ä½“çš„ãªç™ºè¨€ã¯ã‚«ã‚®ã‚«ãƒƒã‚³ã€Œã€ã§å¼•ç”¨
- å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ{opponent_display}ï¼‰ã«å¯¾ã™ã‚‹è©•ä¾¡ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«å«ã‚ã‚‹
- æ€ªæˆ‘äººãƒ»å¾©å¸°é¸æ‰‹ã®çŠ¶æ³ãŒã‚ã‚Œã°å«ã‚ã‚‹
- 1500-2000å­—ç¨‹åº¦

## æ§‹æˆï¼ˆå‹•çš„ãªå°è¦‹å‡ºã—ï¼‰
å–å¾—ã—ãŸæƒ…å ±ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€é©åˆ‡ãªå°è¦‹å‡ºã—ï¼ˆ### ï¼‰ã‚’ä»˜ã‘ã¦æ§‹æˆã™ã‚‹ã€‚
ä¾‹ï¼š
- ### ãƒãƒ¨ãƒ©ãƒ«ã®é›¢è„±ã«ã¤ã„ã¦
- ### å¯¾æˆ¦ç›¸æ‰‹ãƒ˜ã‚¿ãƒ•ã‚§ã¸ã®è­¦æˆ’
- ### å†¬ã®ç§»ç±å¸‚å ´ã§ã®è£œå¼·
- ### è‹¥æ‰‹é¸æ‰‹ã®èµ·ç”¨

â€» æƒ…å ±ãŒãªã„é …ç›®ã¯ä½œæˆã—ãªã„ã€‚å›ºå®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã¯ãªãã€å†…å®¹ã«å³ã—ãŸè¦‹å‡ºã—ã«ã™ã‚‹ã“ã¨ã€‚""",
        "char_limit": (1500, 2000),
        "use_grounding": True,
    },

    "same_country_trivia": {
        "label": "åŒå›½å¯¾æ±ºãƒˆãƒªãƒ“ã‚¢",
        "template": """ã‚ãªãŸã¯ã‚µãƒƒã‚«ãƒ¼å°‚é–€ã®ãƒˆãƒªãƒ“ã‚¢ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚

ä»¥ä¸‹ã®åŒå›½å¯¾æ±ºã«ã¤ã„ã¦ã€é¸æ‰‹é–“ã®é–¢ä¿‚æ€§ã‚„èˆˆå‘³æ·±ã„äº‹å®Ÿï¼ˆå°ãƒã‚¿ï¼‰ã‚’æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

å¯¾æ±ºã‚«ãƒ¼ãƒ‰:
{matchup_context}

Requirements:
1. é¸æ‰‹åŒå£«ã®é–¢ä¿‚æ€§ã‚’å„ªå…ˆçš„ã«è¨˜è¼‰:
   - ä»£è¡¨ãƒãƒ¼ãƒ ã§ã®å…±æ¼”
   - éå»ã®ã‚¯ãƒ©ãƒ–ã§ã®åŒåƒšé–¢ä¿‚
   - ãƒ¦ãƒ¼ã‚¹æ™‚ä»£ã®å…±æ¼”
2. èˆˆå‘³æ·±ã„ãƒˆãƒªãƒ“ã‚¢ãŒã‚ã‚Œã°è¿½åŠ :
   - åŒéƒ·ã€åŒå¹´é½¢
   - éå»ã®å¯¾æˆ¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
   - ãƒ©ã‚¤ãƒãƒ«é–¢ä¿‚
3. å­—æ•°: 50-150å­—/å›½
4. è©¦åˆçµæœã«ã¯çµ¶å¯¾ã«è¨€åŠã—ãªã„
5. ç¢ºå®Ÿãªäº‹å®Ÿã®ã¿è¨˜è¼‰ï¼ˆæ¨æ¸¬ã‚„ä¸ç¢ºã‹ãªæƒ…å ±ã¯é¿ã‘ã‚‹ï¼‰
6. å‰ç½®ãæ–‡ã¯ä¸è¦ã€æœ¬æ–‡ã®ã¿

Output Format:
ğŸ‡¯ğŸ‡µ **æ—¥æœ¬**
**é¸æ‰‹A**ï¼ˆãƒãƒ¼ãƒ Aï¼‰ã¨**é¸æ‰‹B**ï¼ˆãƒãƒ¼ãƒ Bï¼‰ã€‚[é–¢ä¿‚æ€§ãƒ»å°ãƒã‚¿]""",
        "char_limit_per_country": (50, 150),
        "use_grounding": False,
    },
}


# =============================================================================
# ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
# =============================================================================

def build_prompt(
    prompt_type: str,
    **kwargs
) -> str:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¹ãƒšãƒƒã‚¯ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—ã‚’ç”Ÿæˆ

    Args:
        prompt_type: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥ï¼ˆnews_summary, tactical_previewç­‰ï¼‰
        **kwargs: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°

    Returns:
        ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—
    
    Raises:
        ValueError: ä¸æ˜ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥
    """
    spec = GEMINI_PROMPTS.get(prompt_type)
    if not spec:
        raise ValueError(f"Unknown prompt type: {prompt_type}")

    template = spec["template"]
    return template.format(**kwargs)


def get_prompt_config(prompt_type: str) -> Dict[str, Any]:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥ã®è¨­å®šã‚’å–å¾—

    Args:
        prompt_type: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥

    Returns:
        è¨­å®šè¾æ›¸ï¼ˆchar_limit, use_groundingç­‰ï¼‰
    
    Raises:
        ValueError: ä¸æ˜ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥
    """
    spec = GEMINI_PROMPTS.get(prompt_type)
    if not spec:
        raise ValueError(f"Unknown prompt type: {prompt_type}")

    return {
        "label": spec.get("label", prompt_type),
        "char_limit": spec.get("char_limit"),
        "char_limit_per_country": spec.get("char_limit_per_country"),
        "text_limit": spec.get("text_limit"),
        "use_grounding": spec.get("use_grounding", False),
    }


def get_char_limit(prompt_type: str) -> Optional[Tuple[int, int]]:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥ã®æ–‡å­—æ•°åˆ¶é™ã‚’å–å¾—

    Args:
        prompt_type: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥

    Returns:
        (æœ€å°, æœ€å¤§) ã¾ãŸã¯ None
    """
    config = get_prompt_config(prompt_type)
    return config.get("char_limit")


def uses_grounding(prompt_type: str) -> bool:
    """
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒGroundingæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã‹åˆ¤å®š

    Args:
        prompt_type: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¨®åˆ¥

    Returns:
        Groundingä½¿ç”¨ã®å ´åˆTrue
    """
    config = get_prompt_config(prompt_type)
    return config.get("use_grounding", False)
