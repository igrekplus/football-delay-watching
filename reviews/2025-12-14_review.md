# プロジェクト横断レビュー（実施日: 2025-12-14 JST）

## Step1 — 要点抽出
- 目的: 試合結果のネタバレを防ぎつつ、毎朝07:00 JSTにプレミア/CLの観戦ガイドを自動生成。
- 中核フロー: 試合抽出→優先度選定→固定情報取得→ニュース要約/戦術プレビュー→ネタバレ検閲→レポート/メール配信。
- 非機能: 推測禁止、JST基準の時間窓、E1/E2/E3の明示、API無料枠運用。

## Step3 — 問題点（重大度付き）
- **High**: `config.USE_API_CACHE=True` でキャッシュヒットした場合、`CachedResponse` に `headers` が無いため `match_processor._fetch_matches_from_api` のレートリミット参照で `AttributeError` が発生し処理が即死する。キャッシュ利用時に本番が止まるため、ヘッダーを持たせる or 参照をガードする必要がある。（src/api_cache.py:72-88 ↔ src/match_processor.py:114-121）
- **High**: マンチェスター・シティの「絶対優先」および日本人先発Aランク判定が実質無効。`_assign_rank` は City でも "S" しか返さず "Absolute" を付与しないため、`MATCH_LIMIT=1` のデバッグ運用ではCLのSランクに押し出され City が落ちうる。また日本人先発判定はラインナップ取得前に実行されるため常に空配列で評価され昇格しない。要件3.2の優先度ロジックと乖離し、対象試合選定が誤る。（src/match_processor.py:185-206, 238-274）
- **Medium**: CLチームの直近フォーム取得がリーグID 39(EPL) に固定されており、EPL以外のチームでは常に空文字になる。要件の固定情報「直近フォーム(W/L/D)」が欠損しても E2 に格下げされず、誤って正常扱いで出力される。（src/facts_service.py:172-198, 148-171）

## Step4 — 改善案
- CachedResponse に `headers` を保持するか、キャッシュ利用時はレートリミット参照をスキップする防御コードを追加する。
- ランク付けは (a) City を `rank="Absolute"` に設定、(b) ラインナップ取得後に日本人先発判定を再評価するか FactsService 結果を入力に再計算する。選定時は Absolute を必ず1枠確保する分岐を入れる。
- チームフォーム取得ではリーグIDをフィクスチャのリーグから解決し、取得不能時は `error_status=E2` をセットしてレポートに明示する。

## Step5 — 次アクション
1) 上記3点を修正してデバッグ/本番両モードで実行テスト。2) Eステータス付与とレポート表示の整合を再確認。3) City絶対優先・日本人先発昇格が期待通り動くことを回帰テストに追加。
