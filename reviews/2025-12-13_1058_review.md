# 設計資料と実装の乖離レビュー（作成: 2025-12-13 10:58 JST）

## 重大度 High
- 要件3.1「D-1 08:00〜D 07:59」の時間帯抽出未実装。`src/match_processor.py` は日付=昨日のみでAPIを叩き、UTC時間のままフィルタもタイムゾーン調整も行わないため、対象外試合や未終了試合を含む恐れ。設計書(system_design.md 2.1)と要件定義(試合抽出機能)に未整合。
- ランク付け/選定ロジックが仕様と乖離。要件では「絶対優先=マンチェスター・シティのみ」「S=上位対決(CL/プレミア)」「A=日本人先発」だが、実装は `config.PRIORITY_TEAMS` に Arsenal/Chelsea を含め、S/A判定もクラブ名ハードコードとBrighton特例のみ。順位判定も日本人先発判定も未実装。 (`config.py`, `src/match_processor.py`)
- ニュース収集の前提ガード未実装。要件3.4で求める「公開日時 < キックオフ」「preview系キーワード必須」「言語を英/日のみに限定」が無く、Custom Search結果をそのまま採用。試合後記事混入リスクが高い。 (`src/news_service.py`)
- スポイラー検閲の方針ズレ。要件3.7は「禁止表現を含む記事/文を除外 or マスクで安全側」だが、実装はスコアと結果語を文字置換して本文を残すためネタバレが残存し得る。またスコア検出は "1-0" 形式のみでエンダッシュや "3 to 1" を漏らす。 (`src/spoiler_filter.py`)
- GitHub Actions がリポジトリルートに対して誤パス指定。`pip install -r fb-non-result/requirements.txt` などディレクトリを一段深く指定しており、設計書 2.3 の実行フローと不整合。環境によっては依存インストールや `git add` が失敗する。 (`.github/workflows/daily_report.yml`, `.github/workflows/fb-non-daily-report.yml`)

## 重大度 Medium
- 固定情報の必須項目不足とエラーハンドリング未整合。要件3.3で必須の「出場停止・負傷者」「直近フォーム」「xG/ポゼッション」等を取得せず、欠損時にE2へ格下げもしないまま `Normal` を出力。 (`src/facts_service.py`, `src/report_generator.py`)
- 要約生成の制約未検証。要件3.5で指定された 600〜1,000字チェックや記事ゼロ時のE3付与がなく、LLMエラー時も `Normal` のまま "Error generating" 文字列を出すだけ。 (`src/news_service.py`)
- 出力ファイルの仕様混在。configは `OUTPUT_FILE=daily_report.md` を保持するが実装は `reports/YYYY-MM-DD.md` を生成し、要件定義では daily_report.md の記載が残る部分あり。どれを正とするか整理が必要。 (`config.py`, `src/report_generator.py`, `docs/requirement.md`)
- `USE_MOCK_DATA` デフォルトが設計意図と逆。キーが揃っても明示的にFalse指定しない限りモックを使い続けるため、本番ワークフローで実データ取得できないリスク。 (`config.py`)

## 重大度 Low
- スポイラー置換の副作用で "goalkeeper" → "[CENSORED]keeper" など正常語が破壊される。可読性劣化。 (`src/spoiler_filter.py`)
- `preview_url` が常にダミー `https://example.com/tactical-preview`。設計上は参照記事URLを添付と記載。 (`src/news_service.py`)

## 補足
- 設計との整合を取る際は、まず要件定義( docs/requirement.md )を正とし、system_design.md と実装をそれに合わせて更新することを推奨。
- 修正後は E2/E3 の付与とレポート表示を合わせて検証すること。
